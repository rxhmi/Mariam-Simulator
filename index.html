<!DOCTYPE html>
<html>
<head>
  <title>Aggressive Pistol Game - BOSS EDITION</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin: 0; background: #111; overflow: hidden; cursor: crosshair; }
    canvas { display: block; margin: 20px auto; background: #222; border: 4px solid #444; }
  </style>
</head>
<body>

<canvas id="game" width="800" height="600"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* ================= IMAGE PRELOAD (MOBILE FIX) ================= */
const images = {};
const imageSources = {
  gameOver: "./Dogswag.jpg",
  player: "./cute.jpg",
  enemy: "./rehman.png",
  boss: "./amna.png",
  win: "./win.jpg"
};

let imagesLoaded = 0;
const totalImages = Object.keys(imageSources).length;

for (let key in imageSources) {
  images[key] = new Image();
  images[key].src = imageSources[key];
  images[key].onload = () => {
    imagesLoaded++;
    if (imagesLoaded === totalImages) startGame();
  };
  images[key].onerror = () => {
    console.error("Image failed to load:", imageSources[key]);
  };
}

/* ================= GAME START ================= */
function startGame() {

let player = { x: 380, y: 280, size: 35, speed: 5 };
let mouse = { x: 0, y: 0 };
let keys = {};
let enemies = [];
let bullets = [];
let bonuses = [];
let bossProjectiles = [];
let health = 10;
let score = 0;
let gameOver = false;
let gameWin = false;
let gunLevel = 1;
let powerUpTimer = 0;
let autoFireTimer = 0;

let bossActive = false;
let boss = null;
let bossAnnounceTimer = 0;

/* ================= INPUT ================= */
window.addEventListener("mousemove", e => {
  const rect = canvas.getBoundingClientRect();
  mouse.x = e.clientX - rect.left;
  mouse.y = e.clientY - rect.top;
});

document.addEventListener("keydown", e => {
  keys[e.key.toLowerCase()] = true;
  if (e.key.toLowerCase() === "r" && (gameOver || gameWin)) location.reload();
});

document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);
canvas.addEventListener("mousedown", () => shoot());

function shoot() {
  if (gameOver || gameWin) return;
  const cx = player.x + player.size / 2;
  const cy = player.y + player.size / 2;
  const angle = Math.atan2(mouse.y - cy, mouse.x - cx);

  for (let i = 0; i < gunLevel; i++) {
    const spread = (i - (gunLevel - 1) / 2) * 0.2;
    bullets.push({
      x: cx, y: cy,
      vx: Math.cos(angle + spread) * 12,
      vy: Math.sin(angle + spread) * 12,
      size: 7
    });
  }
}

function isColliding(a, b) {
  return a && b &&
    a.x < b.x + b.size &&
    a.x + a.size > b.x &&
    a.y < b.y + b.size &&
    a.y + a.size > b.y;
}

function spawnEnemy() {
  if (bossActive) return;
  const angle = Math.random() * Math.PI * 2;
  enemies.push({
    x: player.x + Math.cos(angle) * 500,
    y: player.y + Math.sin(angle) * 500,
    size: 40,
    speed: 1.5
  });
}

function spawnBoss() {
  bossActive = true;
  bossAnnounceTimer = 180;
  boss = { x: 350, y: 50, size: 100, hp: 100, maxHp: 100, vx: 2, vy: 1, shootTimer: 0 };
  enemies = [];
}

function update() {
  if (gameOver || gameWin) return;

  if (keys["w"]) player.y -= player.speed;
  if (keys["s"]) player.y += player.speed;
  if (keys["a"]) player.x -= player.speed;
  if (keys["d"]) player.x += player.speed;

  if (score >= 30 && !bossActive && !boss) spawnBoss();

  bullets.forEach((b, i) => {
    b.x += b.vx;
    b.y += b.vy;
    if (b.x < 0 || b.y < 0 || b.x > canvas.width || b.y > canvas.height)
      bullets.splice(i, 1);
  });

  enemies.forEach((e, ei) => {
    const dx = player.x - e.x;
    const dy = player.y - e.y;
    const d = Math.hypot(dx, dy);
    e.x += dx / d * e.speed;
    e.y += dy / d * e.speed;

    bullets.forEach((b, bi) => {
      if (isColliding(b, e)) {
        enemies.splice(ei, 1);
        bullets.splice(bi, 1);
        score++;
        spawnEnemy();
      }
    });
  });
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (gameOver) {
    ctx.drawImage(images.gameOver, canvas.width/2-150, 50, 300, 250);
    return;
  }

  if (gameWin) {
    ctx.drawImage(images.win, canvas.width/2-200, 50, 400, 300);
    return;
  }

  if (bossAnnounceTimer > 0) {
    ctx.fillStyle = "red";
    ctx.font = "bold 60px Arial";
    ctx.textAlign = "center";
    ctx.fillText("BOSS FIGHT", canvas.width/2, canvas.height/2);
    bossAnnounceTimer--;
  }

  ctx.drawImage(images.player, player.x, player.y, player.size, player.size);
  enemies.forEach(e => ctx.drawImage(images.enemy, e.x, e.y, e.size, e.size));

  ctx.fillStyle = "yellow";
  bullets.forEach(b => ctx.fillRect(b.x, b.y, b.size, b.size));

  ctx.fillStyle = "white";
  ctx.fillText("HP: " + health, 20, 30);
  ctx.fillText("KILLS: " + score, 20, 55);
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

spawnEnemy();
loop();
}
</script>

</body>
</html>
